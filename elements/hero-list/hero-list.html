<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../hero-sparkline/hero-sparkline.html">
<dom-module id="hero-list">
  <style>
      .labels {
        position: relative;
        padding: 1em 20px;
      }
      .right {
        position: absolute;
        right: 20px;
        bottom: 1em;
      }
      @media screen and (max-width: 480px) {
        .labels .v-label.v-label-h3.right {
          position: static;
          font-size: 1em;
          padding-top: 0.3em;
        }
      }
      vaadin-grid {
        position: relative;
        width: 100%;
        height: 100%;
        font: inherit;
      }
    </style>
  <template>
    <iron-ajax auto url="../../rest/list.json" handle-as="json" method="GET" id="ajax"></iron-ajax>
    <div class="labels">
      <div class="v-label v-label-h2 no-margin">Superhero Roster</div>
      <div class="v-label v-label-h3 v-label-light no-margin right"><span>{{size}}</span> heroes on duty</div>
    </div>
    <vaadin-grid flex="" id="grid">
    <table>
      <colgroup>
        <col name="rank" header-text="Rank">
        <col name="heroname" header-text="Name">
        <col name="vitals" header-text="Vitals">
        <col name="location" header-text="Location">
        <col name="status" header-text="Status">
      </colgroup>
    </table>
    </vaadin-grid>
  </template>
  <script>
    (function () {
      Polymer({
        is: 'hero-list',
        properties: {
          current: { notify: true },
          hero: { notify: true },
          heroes: { notify: true },
          page: {
            notify: true,
            observer: 'pageChanged'
          }
        },
        ready: function() {
          this.size = 0;
          this.$.ajax.addEventListener('response', function(e) {
            this.heroes = e.detail.response.heroes;
            this.size = this.heroes.length;

            var grid = this.$.grid;
            grid.columns[3].renderer = function(cell) {
              cell.element.innerHTML = ('(' + cell.data.latitude + ', ' + cell.data.longitude + ')').replace(/(\d\.\d{6})\d+/g, '$1');
            };
            grid.columns[2].renderer = function(cell) {
              cell.element.innerHTML = '<hero-sparkline colors="#DF0016,#3777DD" height="12" width="90" points="[[' + cell.data.heart + '],[' + cell.data.coffee + ']]"></hero-sparkline>';
            };
            grid.items = this.heroes;
            window.heroes = this.heroes;
          }.bind(this));

          this.$.grid.addEventListener('select', function(e) {
            this.current = this.$.grid.selection.selected()[0];
            if (this.heroes && this.current >= 0) {
              this.page = 1;
              this.hero = this.heroes[this.current];
            } else {
              this.page = 0;
            }
        }.bind(this));
        },
        pageChanged: function() {
          if (this.page == -1) {
            this.size = this.heroes.length;
            this.$.grid.refresh();
          } else if (this.page === 0) {
            this.$.grid.selection.clear();
          }
        }
      });
    }());
  </script>
</dom-module>
